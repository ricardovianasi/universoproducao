function sourceScript(d,c){var a=c.createElement("script");a.type="text/javascript";a.src=d;var b=c.head||c.getElementsByTagName("head")[0];b.appendChild(a);}function sourceCss(d,c){var b=c.createElement("link");b.href=d;b.type="text/css";b.rel="stylesheet";var a=c.head||c.getElementsByTagName("head")[0];a.appendChild(b);}if(!sourceScript.loaded){sourceCss(tinymce.baseURL+"/plugins/doksoft_maps/style.css",window.document);sourceScript.loaded=true;}function generateMapStaticUrl(b){function a(g){var e=[];for(var f in g){e.push(f+"="+escape(g[f]));}return e.join("&");}function d(){var e=[];for(var f=0;f<b.objects.Marker.length;f++){e.push(b.objects.Marker[f].slice(0,2).join(","));}return e.join("|");}var c={center:b.lat+","+b.lng,zoom:b.zoom,size:b.width+"x"+b.height,maptype:b.type,markers:d(),sensor:false};return"http://maps.googleapis.com/maps/api/staticmap?"+a(c);}function editorPreInitFunc(c,b){function a(f){var d=new tinymce.html.Serializer().serialize(f);var e=document.createElement("div");e.innerHTML=d;return e.firstChild.innerHTML;}return function(){if(tinymce.minorVersion=="2.7"){function d(e){var f=document.createElement("div");f.innerHTML=e;return f.childNodes;}c.onPostProcess.add(function(f,g){var e=g.node.innerHTML;e=e.replace(/<img[^>]*?\\?>/g,function(l,k,j,i){var h=d(l)[0];if(h.className.indexOf("doksoft_map")>-1){return'<div class="doksoft_map" data-options="'+h.getAttribute("data-options")+'">'+unescape(h.getAttribute("data-html"))+"</div>";}return l;});g.content=e;});}else{c.serializer.addNodeFilter("img",function(e,f){for(var g=0;g<e.length;g++){if(e[g].attr("data-options")){e[g].replace((new tinymce.html.DomParser({validate:false})).parse('<div class="doksoft_map" data-options="'+e[g].attr("data-options")+'">'+unescape(e[g].attr("data-html"))+"</div>"));}}});c.parser.addNodeFilter("div",function(e,f){for(var h=0;h<e.length;h++){node=e[h];if(node.attr("data-options")){var g=a(node);var j=g.match(/doksoft_map_\d+/)[0];node.replace((new tinymce.html.DomParser({validate:false})).parse(b({id:j,url:generateMapStaticUrl(JSON.parse(unescape(node.attr("data-options")))),options:unescape(node.attr("data-options")),html:g})));}}});}};}tinymce.create("tinymce.plugins.DoksoftMapsPlugin",{createControl:function(d,a){switch(d){case"doksoft_maps":var c=a.editor;function b(e){return tinymce.DOM.createHTML("img",{id:e.id,"data-mce-object":"doksoft_map",src:(e.url),"class":"doksoft_map mceItem","data-options":escape(e.options),"data-html":escape(e.html)});}c.onPreInit.add(editorPreInitFunc(c,b));this.editor=a.editor;this.editor.onNodeChange.add(function(f,e,g){setTimeout(function(){e.setActive("doksoft_maps",+g.getAttribute("data-mce-selected")&&g.nodeName=="IMG"&&g.className.match("doksoft_map"));},0);});return this.editor.controlManager.createButton("doksoft_maps",{title:c.getLang("doksoft_maps.button_tooltip"),tooltip:c.getLang("doksoft_maps.button_tooltip"),onclick:function(){var f=tinymce.baseURL+"/plugins/doksoft_maps";var e=a.editor.getParam("doksoft_maps_dialog_height");if(!e||e<570){e&&window.console&&window.console.warn("doksoft_maps_dialog_height is too small, using default value");e=570;}if(navigator.userAgent.match(/MSIE/)&&e<590){e=590;}tinymce.EditorManager.activeEditor.windowManager.open({file:f+"/tinymce-3-popup.html",width:a.editor.getParam("doksoft_maps_dialog_width")||600,height:e,inline:1});}});}return null;}});tinymce.PluginManager.requireLangPack("doksoft_maps");tinymce.PluginManager.add("doksoft_maps",tinymce.plugins.DoksoftMapsPlugin);