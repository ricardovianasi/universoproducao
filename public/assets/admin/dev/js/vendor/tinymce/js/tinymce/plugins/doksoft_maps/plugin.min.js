function getHtmlHead(){return document.head||document.getElementsByTagName("head")[0];}function sourceScript(c,b){var a=b.createElement("script");a.type="text/javascript";a.src=c;getHtmlHead().appendChild(a);}function sourceCss(c,b){var a=b.createElement("link");a.href=c;a.type="text/css";a.rel="stylesheet";getHtmlHead().appendChild(a);}if(!sourceCss.loaded){sourceCss(tinymce.baseURL+"/plugins/doksoft_maps/style.css",tinyMCE.DOM.win.document);sourceCss.loaded=true;}function generateMapStaticUrl(b){function a(g){var e=[];for(var f in g){e.push(f+"="+escape(g[f]));}return e.join("&");}function d(){var e=[];for(var f=0;f<b.objects.Marker.length;f++){e.push(b.objects.Marker[f].slice(0,2).join(","));}return e.join("|");}var c={center:b.lat+","+b.lng,zoom:b.zoom,size:b.width+"x"+b.height,maptype:b.type,markers:d(),sensor:false};return"http://maps.googleapis.com/maps/api/staticmap?"+a(c);}function editorPreInitFunc(c,b){function a(f){var d=new tinymce.html.Serializer().serialize(f);var e=document.createElement("div");e.innerHTML=d;return e.firstChild.innerHTML;}return function(){c.serializer.addNodeFilter("img",function(d,e){for(var f=0;f<d.length;f++){if(d[f].attr("data-options")){d[f].replace((new tinyMCE.html.DomParser({validate:false})).parse('<div class="doksoft_map" data-options="'+d[f].attr("data-options")+'">'+unescape(d[f].attr("data-html"))+"</div>"));}}});c.parser.addNodeFilter("div",function(d,e){for(var g=0;g<d.length;g++){node=d[g];if(node.attr("data-options")){var f=a(node);var h=f.match(/doksoft_map_\d+/)[0];node.replace((new tinyMCE.html.DomParser({validate:false})).parse(b({id:h,url:generateMapStaticUrl(JSON.parse(unescape(node.attr("data-options")))),options:unescape(node.attr("data-options")),html:f})));}}});};}tinymce.PluginManager.requireLangPack("doksoft_maps");tinymce.PluginManager.add("doksoft_maps",function(c,b){var e=c.getParam("doksoft_maps_dialog_width")||600;var g=c.getParam("doksoft_maps_dialog_height");if(!g||g<520){g&&window.console&&window.console.warn("doksoft_maps_dialog_height is too small, using default value");g=520;}if(navigator.userAgent.match(/MSIE/)&&g<550){g&&window.console&&window.console.warn("doksoft_maps_dialog_height is too small for IE, using default IE value");g=550;}var d;function a(h){return tinyMCE.DOM.createHTML("img",{id:h.id,"data-mce-object":"doksoft_map",src:(h.url),"class":"doksoft_map","data-options":escape(h.options),"data-html":escape(h.html)});}var f={title:c.translate("button_tooltip"),tooltip:c.translate("button_tooltip"),type:"button",icon:false,stateSelector:"img[class=doksoft_map]",onclick:function(){var j;var i=c.selection.getNode();if(i.className=="doksoft_map"){c.selection.select(i);window.dataForLoadIntoMap=tinyMCE.util.JSON.parse(unescape(i.getAttribute("data-options")));}else{window.dataForLoadIntoMap=null;}var h=function(k){d=tinyMCE.DOM.select("iframe",tinyMCE.DOM.get(j._id+"-body"))[0].contentWindow;j.close();var m=d.map.generateCodeMap();var l=a({id:d.map.getNewMapId(),url:generateMapStaticUrl(m),options:tinyMCE.util.JSON.serialize(m),html:d.map.getHtmlCode()});c.insertContent(l);return false;};j=c.windowManager.open({title:window.dataForLoadIntoMap?c.translate("dialog_edit_title"):c.translate("dialog_insert_title"),width:e,height:g,url:tinymce.baseURL+"/plugins/doksoft_maps/popup.html",buttons:[{text:"Ok",subtype:"primary",onclick:h},{text:"Cancel",onclick:"close"}]});}};c.addButton("doksoft_maps",f);c.on("ObjectSelected",function(h){if(h.target.getAttribute("class")=="doksoft_map"||h.target.getAttribute("class")=="doksoft_map_preview"){h.preventDefault();}});c.on("preInit",editorPreInitFunc(c,a));});